<!DOCTYPE html>
<html lang="en">

  <head>
    
  <script type="text/javascript">
      var host = "jhaug.com";
      if ((host == window.location.host) && (window.location.protocol != "https:"))
          window.location.protocol = "https";
  </script>
      
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    
      Hive Monitoring Prototype Version 2 -- An ESP Under the Hive &middot; BeeSci
    
  </title>
  <link rel="canonical" href=" { { site.url } }{ { page.url } }" />
  <link rel="stylesheet" href="/styles.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link rel="alternate" type="application/atom+xml" title="BeeSci" href="/atom.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <h3 class="masthead-title">
        <a href="/" title="Home">BeeSci</a>

        
          &nbsp;&nbsp;&nbsp;
          <small><a href="/about">About</a></small>
        
          &nbsp;&nbsp;&nbsp;
          <small><a href="/archive">Archive</a></small>
        

        <!-- <small><span style="color:red">&nbsp; &nbsp; BETA VERSION </span></small> -->
        </h3>
      </header>

      <main>
        <article class="post">
  <h1 class="post-title">Hive Monitoring Prototype Version 2 -- An ESP Under the Hive</h1>
  <time datetime="2021-02-07T00:00:00-08:00" class="post-date">07 Feb 2021</time>
  <div class="message">
üêù  This is the second iteration of my beehive monitoring prototype.
Previous iteration <a href="hardware.html">here</a>, subsequent iteration <a href="hardware-v3.html">here</a>.
</div>

<p>I‚Äôve learned from my <a href="hardware.html">previous prototype</a> that hive temperature readings taken right underneath the lid are not nearly as informative as they might seem. So maybe instead of the device living inside the hive lid, I should be taking readings near the bottom of the hive. And as long as I‚Äôm gonna be messing with the underside of the hive, I‚Äôd like to start taking some weight measurements. Weight increase can be good indicator of hive growth, as it means the bees are bringing in nectar and pollen.</p>

<h3 id="electronics">Electronics</h3>

<p>If this thing is going to run off of a battery, I‚Äôll have to use something that consumes much less power than a Raspberry Pi. I decided on an ESP32, which is an <em>awesome</em> SoC. I hooked it up to an analog microphone, 2 temperature sensors, a load cell amplifier, and a micro sd card adapter.</p>

<p><img src="../assets/v2-internals.jpg" alt="The front of the prototype" />
<em>The inside of the device.</em></p>

<p>The whole thing is hooked up with DuPont wires. Not very nice to look at, but it does work.</p>

<h3 id="enclosure">Enclosure</h3>

<p>The enclosure was really a way for me to explore some of Fusion 360‚Äôs cooler features. It‚Äôs made of four parts: a 3D-printed hexagonal box, a threaded pipe with an integrated screen that attaches to the bottom of the hive, a lid for the box, and a nut to hold the pipe in place. Here‚Äôs how it attaches to the bottom board to get readings from internal hive conditions:</p>

<p><img src="../assets/v2-pipe.jpg" alt="The pipe of the prototype" /></p>

<p>It‚Äôs super cool that all these pieces can be 3D printed in-place and without support!
Here‚Äôs the underside of the hive bottom board, with the prototype attached:
<img src="../assets/v2-on-box.jpg" alt="The bottom board with device" /></p>

<p>Inside of the rightmost support thing is a load cell mounted to pieces of aluminum angle bar, with some wood on the outside. The other side is just a 2x4 that has been ripped to an equal height.</p>

<h3 id="firmware">Firmware</h3>

<p>The hardware is only half the battle ‚Äì the next step is firmware. I‚Äôll spare you from reading the crappy code. Basically, the ESP32 has a little RTC that can be used as a wakeup alarm. Every 10 minutes, it wakes up from a deep-sleep mode, powers on all sensor peripherals, waits for readings to stabilize, writes the data onto the SD card, and then goes back to sleep. And every few wakeups, it will sync the past few readings with a server I have on my local network. Nothing fancy, just a Node.js script that writes the data into a database. I‚Äôll go into more detail on firmware design for the ESP32 in a later post.</p>

<h3 id="data-analysis">Data Analysis</h3>

<p>This is one of those good news/bad news situations. The good? I was able to get great weight data and good audio. But I didn‚Äôt notice a substantial difference in temperature readings between the inside and outside of the hive, even though I thought I properly insulated the inner sensor.</p>

<p>This is further evidence to me that the best way to ‚Äútake a beehive‚Äôs temperature‚Äù is to measure from the <strong>center of the broodnest.</strong>  Bees require precise thermoregulation of their brood.</p>

<p>Anyways, here‚Äôs what the raw weight data looks like:</p>

<p><img src="../assets/rawweight_annotated.jpg" alt=" Raw Weight Annotated " /></p>

<p>What the heck is going on here? I see small daily fluctuations as well as instantaneous ‚Äústeps‚Äù in the signal (indicated by red arrows). These steps are caused by me screwing around with the hive; putting rocks on the hive lid to prevent raccoons or bears from getting in, adding/removing a roof for rain shielding, etc.</p>

<p>There are two questions I‚Äôd like to answer:</p>
<ul>
  <li>Can I detect and filter out changes in weight due to human activity?</li>
  <li>Is the daily fluctuation caused only by bee activity? Or is there some other factor at play?</li>
</ul>

<h4 id="detecting-instantaneous-change">Detecting Instantaneous Change</h4>

<p>The easiest way of detecting those steps in the signal is to look at the percent change between each data point and the subsequent one.</p>

<p><img src="../assets/percentchange.jpg" alt=" Percent Change " /></p>

<p>This could be good enough, but requires some manual thresholding. Moreover, if human activity results in a relatively small change in weight (like the point annoted with the red arrow) then the threshold would need to be really specific.</p>

<p>An alternative route would be to use a more special-purpose algorithm for step detection, like <a href="https://en.wikipedia.org/wiki/CUSUM">CUSUM</a>. Here is a chart showing the detections with CUSUM (in orange) overlaid atop the raw weight signal:</p>

<p><img src="../assets/cusum_overlay.jpg" alt=" CUSUM " /></p>

<p>The assumption here is that instantaneous changes in weight are likely due to human activity, while slower changes are likely due to bee activity (and other stuff, which we‚Äôll get into later). By doing this separation we can filter out the step functions in the data:</p>

<p><img src="../assets/humandelta_beedelta.jpg" alt=" Human and Bee Delta " /></p>

<p>The cumulative loss in weight over this period of time is normal. During winter months, honey bees go into a sort of hibernation mode. They live off the honey stores they‚Äôve collected during the year and generally reduce their energy expenditure. This isn‚Äôt to say that they don‚Äôt still fly around and collect resources during the winter; if conditions are right, they will. But because of a dearth in nectar supply and decreasing temperatures, a decrease in hive weight is to be expected.</p>

<h4 id="causes-of-daily-fluctuations">Causes of Daily Fluctuations</h4>

<p>Speaking of temperature, I‚Äôm interested to know what is causing these daily fluctuations in weight. I suspect it is not just bees leaving the hive and returning. That may play a part, but I think other contributing causes may be related to temperature and/or humidity.</p>

</article>


<aside class="related">
  <h3>Related posts</h3>
  <ul class="related-posts">
    
      <li>
        <a href="/hardware-v3.html">
          Hive Monitoring Prototype Version 3 -- It's Inside
          <small><time datetime="2021-04-21T00:00:00-07:00">21 Apr 2021</time></small>
        </a>
      </li>
    
      <li>
        <a href="/hardware.html">
          Hive Monitoring Prototype Version 1 -- A Pi on the Roof
          <small><time datetime="2020-07-14T00:00:00-07:00">14 Jul 2020</time></small>
        </a>
      </li>
    
      <li>
        <a href="/big-handle.html">
          Big Handle
          <small><time datetime="2020-07-06T00:00:00-07:00">06 Jul 2020</time></small>
        </a>
      </li>
    
  </ul>
</aside>


      </main>

      <footer class="footer">
        <small>
          &copy; <time datetime="2022-03-24T20:31:02-07:00">2022</time>. All rights reserved.
        </small>
      </footer>
    </div>

    
     <script>
       (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
       ga('create', 'UA-83227079-1', 'auto');
       ga('send', 'pageview');
     </script>
    

    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
    </script>
    <script type="text/javascript"
        src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>

    <style>
.videoWrapper {
	position: relative;
	padding-bottom: 56.333%;
	height: 0;
    background: black;
}
.videoWrapper iframe {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
    border: 0;
}
</style>

<script>
function get_youtube_id(url) {
    var p = /^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;
    return (url.match(p)) ? RegExp.$1 : false;
}
function vimeo_embed(url,el) {
    var id = false;
    $.ajax({
      url: 'https://vimeo.com/api/oembed.json?url='+url,
      async: true,
      success: function(response) {
        if(response.video_id) {
          id = response.video_id;
          if(url.indexOf('autoplay=1') !== -1) var autoplay=1; else var autoplay=0;
          if(url.indexOf('loop=1') !== -1) var loop=1; else var loop=0;
          var theInnerHTML = '<div class="videoWrapper"><iframe src="https://player.vimeo.com/video/'+id+'/?byline=0&title=0&portrait=0';
          if(autoplay==1) theInnerHTML += '&autoplay=1';
          if(loop==1) theInnerHTML += '&loop=1';
          theInnerHTML += '" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></div>';
          el.innerHTML = theInnerHTML;
        }
      }
    });
}
function video_embed() {
    var p = document.getElementsByTagName('p');
    for(var i = 0; i < p.length; i++) {
        //check if this is an external url (that starts with https:// or http://
        if (p[i].innerHTML.indexOf("http://") == 0 ||
            p[i].innerHTML.indexOf("https://") == 0) {
            var youtube_id = get_youtube_id(p[i].innerHTML);
            if(youtube_id) {
                if(p[i].innerHTML.indexOf('autoplay=1') !== -1) var autoplay=1; else var autoplay=0;
                if(p[i].innerHTML.indexOf('loop=1') !== -1) var loop=1; else var loop=0;
                var theInnerHTML = '<div class="videoWrapper"><iframe width="720" height="420" src="https://www.youtube.com/embed/' + youtube_id + '?rel=0&showinfo=0';
                if(autoplay==1) theInnerHTML += '&autoplay=1';
                if(loop==1) theInnerHTML += '&loop=1&playlist='+youtube_id+'&version=3';
                if(p[i].innerHTML.indexOf('start=') !== -1) theInnerHTML += '&start='+p[i].innerHTML.substring(p[i].innerHTML.indexOf('start=')+6);
                theInnerHTML += '" frameborder="0" allowfullscreen></iframe></div>';
                p[i].innerHTML = theInnerHTML;
            }
            if(p[i].innerHTML.indexOf('vimeo.com') !== -1) {
                //ask vimeo for the id and place the embed
                vimeo_embed(p[i].innerHTML,p[i]);
            }
        }
    }
}
video_embed();

function mp3_embed() {
    var p = document.getElementsByTagName('p');
    for(var i = 0; i < p.length; i++) {
        if(p[i].innerHTML.indexOf('.mp3') !== -1) {
            var str = p[i].innerHTML.split('?');
            if(str.length == 1) str[1] = '';
            var str1 = str[1];
            str1 = str1.replace('&','').replace('&','');
            str1 = str1.replace('autoplay=1','').replace('autoplay=0','');
            str1 = str1.replace('loop=1','').replace('loop=0','');
            str1 = str1.replace('controls=0','').replace('controls=1','');

            if (str[0].lastIndexOf('.mp3', str[0].length - 4) === str[0].length - 4 && str1.length == 0) {
                if(str[1].indexOf('autoplay=1') !== -1) var autoplay=1; else var autoplay=0;
                if(str[1].indexOf('loop=1') !== -1) var loop=1; else var loop=0;
                if(str[1].indexOf('controls=0') !== -1) var controls=0; else var controls=1;
                var newInnerHTML = '<audio';
                if(autoplay==1) newInnerHTML += ' autoplay';
                if(loop==1) newInnerHTML += ' loop';
                if(controls==1) newInnerHTML += ' controls';
                newInnerHTML += '><source src="'+str[0]+'" type="audio/mpeg">Your browser does not support the audio element.</audio>';
                p[i].innerHTML = newInnerHTML;
            }
        }
    }
}
mp3_embed();
</script>

  </body>
</html>
